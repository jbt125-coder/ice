<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Carnival Game - V10</title>
    <style>
        * { box-sizing: border-box; }
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; 
            background: #0a0a0a;
            font-family: 'Courier New', monospace;
            touch-action: none;
        }

        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a0033 0%, #0d0d0d 50%, #001a1a 100%);
            color: #00ff88; display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
            z-index: 200; text-align: center; padding: 20px;
            overflow-y: auto;
        }

        h1 { 
            font-size: 48px; margin: 20px 0; 
            text-shadow: 0 0 20px #00ff88;
            color: #00ff88;
        }
        h2 { 
            font-size: 32px; margin: 15px 0; 
            color: #ff00ff;
            text-shadow: 0 0 10px #ff00ff;
        }
        p { font-size: 16px; margin: 10px 0; color: #aaa; }

        button {
            padding: 15px 30px; margin: 10px; border-radius: 5px; 
            border: 2px solid #00ff88;
            background: rgba(0,255,136,0.2);
            font-weight: bold; font-size: 18px; cursor: pointer;
            box-shadow: 0 0 20px rgba(0,255,136,0.5);
            color: #00ff88;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
            transition: all 0.2s;
        }
        button:hover { 
            background: rgba(0,255,136,0.4);
            transform: scale(1.05);
        }
        button:active { transform: scale(0.95); }

        .btn-large { padding: 20px 40px; font-size: 24px; }
        .btn-small { padding: 8px 15px; font-size: 14px; }

        input[type="file"] { display: none; }
        
        select {
            margin: 10px; padding: 12px; border-radius: 5px;
            border: 2px solid #00ff88; font-size: 16px;
            background: rgba(0,0,0,0.8);
            color: #00ff88;
            font-family: 'Courier New', monospace;
            width: 90%; max-width: 400px;
        }

        .slots-grid {
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px; 
            max-width: 1200px; 
            width: 100%;
            margin: 20px 0;
            padding: 20px;
        }

        .slot {
            border: 3px dashed rgba(0,255,136,0.3);
            border-radius: 10px;
            padding: 15px;
            background: rgba(0,0,0,0.5);
        }

        .slot-label {
            font-size: 18px;
            font-weight: bold;
            color: #00ff88;
            margin-bottom: 10px;
        }

        .preview-box {
            width: 100%;
            height: 80px;
            border: 2px solid #00ff88;
            border-radius: 5px;
            margin: 5px 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .preview-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-box.empty {
            color: #555;
            font-size: 12px;
        }

        .warning-box {
            background: rgba(255,165,0,0.2);
            border: 2px solid #ffa500;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            max-width: 600px;
        }

        #game-container { 
            position: relative; width: 100vw; height: 100vh; 
            background: linear-gradient(180deg, #0d0d1a 0%, #1a0033 50%, #000 100%);
            display: none; 
        }

        #game-ui {
            position: absolute; top: 0; left: 0; width: 100%; padding: 15px;
            display: flex; justify-content: space-between;
            z-index: 50; pointer-events: none;
        }

        #left-ui, #right-ui { 
            background: rgba(0,0,0,0.8); padding: 15px; 
            border-radius: 5px; 
            border: 2px solid #00ff88;
        }

        #score-display { font-size: 24px; font-weight: bold; color: #00ff88; }
        #level-display { font-size: 20px; font-weight: bold; color: #00ddff; }

        .character {
            position: absolute; 
            width: 200px; height: 200px;
            border-radius: 10px; 
            z-index: 10;
        }

        .character-img {
            width: 100%; height: 100%; object-fit: cover;
            border-radius: 10px; position: absolute;
        }

        .character-reaction {
            width: 100%; height: 100%; object-fit: cover;
            border-radius: 10px; position: absolute;
            opacity: 0; transition: opacity 0.3s;
        }

        .character.reacting .character-reaction {
            opacity: 1;
        }

        .character-emoji {
            font-size: 160px; text-align: center; 
            line-height: 200px;
            filter: drop-shadow(0 0 20px #00ff88);
        }

        .hit-circle {
            position: absolute;
            width: 300px; height: 300px;
            border: 5px solid #00ff88;
            border-radius: 50%;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 40px rgba(0,255,136,0.6);
            animation: pulse-circle 2s infinite;
        }

        @keyframes pulse-circle {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        .projectile { 
            position: absolute; font-size: 50px; z-index: 45; 
            transform: translate(-50%, -50%); 
        }

        .ghost { 
            opacity: 0.5; position: absolute; 
            font-size: 50px; z-index: 44;
            transform: translate(-50%, -50%); 
        }

        .trajectory-dot {
            position: absolute; width: 10px; height: 10px; 
            background: #00ff88; border-radius: 50%;
            z-index: 38; pointer-events: none;
            box-shadow: 0 0 10px #00ff88;
        }

        .band {
            position: absolute; height: 4px; 
            background: #00ff88;
            transform-origin: left center;
            z-index: 39; display: none;
        }

        #slingshot-node {
            position: absolute; bottom: 80px; left: 50%;
            width: 30px; height: 30px; 
            background: radial-gradient(circle, #00ff88, transparent);
            border-radius: 50%;
            transform: translateX(-50%);
            z-index: 41; 
            box-shadow: 0 0 30px #00ff88;
        }

        .plate {
            position: absolute;
            width: 60px; height: 60px;
            background: radial-gradient(circle, #ffffff, #cccccc);
            border-radius: 50%;
            border: 3px solid #666;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            cursor: pointer;
            transition: all 0.2s;
        }

        .plate:hover {
            transform: scale(1.1);
        }

        .plate.broken {
            animation: shatter 0.3s forwards;
        }

        @keyframes shatter {
            0% { transform: scale(1) rotate(0deg); opacity: 1; }
            100% { transform: scale(0.3) rotate(180deg); opacity: 0; }
        }

        .voice-panel {
            background: rgba(0,0,0,0.7);
            border: 2px solid #00ff88;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            width: 90%;
            max-width: 600px;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<!-- TITLE SCREEN -->
<div id="title-screen" class="screen">
    <h1>üé™ CARNIVAL GAME - V10 üé™</h1>
    <button class="btn-large" onclick="showImageSetup()">START SETUP</button>
</div>

<!-- IMAGE SETUP SCREEN -->
<div id="image-setup-screen" class="screen hidden">
    <h2>STEP 1: UPLOAD IMAGES</h2>
    <p>Upload Neutral & Reaction images for each level</p>
    
    <div class="slots-grid" id="slots-grid"></div>
    
    <div class="warning-box">
        <p style="color: #ffa500; font-size: 18px; font-weight: bold;">‚ö†Ô∏è MORE FUN WITH YOUR OWN IMAGES!</p>
        <p style="color: #fff;">Upload photos to personalize your game experience</p>
    </div>
    
    <div style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;">
        <button class="btn-large" onclick="continueWithEmojis()">CONTINUE WITH EMOJIS</button>
        <button class="btn-large" onclick="continueWithImages()" id="images-ready-btn" style="background: rgba(255,215,0,0.3); border-color: #ffd700;">
            UPLOADED IMAGES READY - CONTINUE
        </button>
    </div>
</div>

<!-- AUDIO SETUP SCREEN -->
<div id="audio-setup-screen" class="screen hidden">
    <h2>STEP 2: AUDIO SETUP</h2>
    <p>Record custom voice OR choose text-to-speech voice</p>
    
    <div id="audio-panels"></div>
    
    <button class="btn-large" onclick="startPlateBonus()">CONTINUE TO BONUS ‚Üí</button>
</div>

<!-- PLATE BONUS SCREEN -->
<div id="plate-bonus-screen" class="screen hidden">
    <h1>üéØ BONUS: BREAK THE PLATES!</h1>
    <p style="font-size: 24px; color: #ff00ff;">TAP PLATES TO BREAK THEM</p>
    <div id="plates-broken" style="font-size: 32px; margin: 20px 0;">0 / 10</div>
    
    <div id="plates-container" style="position: relative; width: 90%; max-width: 800px; height: 400px; background: rgba(0,0,0,0.5); border-radius: 10px; border: 2px solid #00ff88;"></div>
    
    <button class="btn-large hidden" id="plates-complete-btn" onclick="startMainGame()">START MAIN GAME ‚Üí</button>
</div>

<!-- GAME CONTAINER -->
<div id="game-container">
    <div id="game-ui">
        <div id="left-ui">
            <div id="score-display">SCORE: 0</div>
        </div>
        <div id="right-ui">
            <div id="level-display">LEVEL: 1</div>
        </div>
    </div>

    <div id="slingshot-node"></div>
    <div id="band-l" class="band"></div>
    <div id="band-r" class="band"></div>
</div>

<!-- LEVEL COMPLETE -->
<div id="level-complete-screen" class="screen hidden">
    <h1>üéâ LEVEL COMPLETE! üéâ</h1>
    <div id="level-stats"></div>
    <button class="btn-large" onclick="nextLevel()">NEXT LEVEL ‚Üí</button>
</div>

<!-- VICTORY -->
<div id="victory-screen" class="screen hidden">
    <h1>üèÜ GAME COMPLETE! üèÜ</h1>
    <div id="victory-stats"></div>
    <button class="btn-large" onclick="location.reload()">PLAY AGAIN</button>
</div>

<script>
// =========================
// GAME STATE
// =========================
const gameState = {
    characters: [],
    currentLevel: 1,
    score: 0,
    activeCharacters: [],
    trajectoryDots: [],
    voices: [],
    usingEmojis: false
};

const presetEmojis = ['üòä','üòé','ü§†','ü§ñ','üëΩ','üê∂','üê±','ü¶Å','üêº','üê∏'];

// Load voices
function loadVoices() {
    gameState.voices = window.speechSynthesis.getVoices();
    if (gameState.voices.length === 0) setTimeout(loadVoices, 100);
}
loadVoices();
if (window.speechSynthesis.onvoiceschanged !== undefined) {
    window.speechSynthesis.onvoiceschanged = loadVoices;
}

// =========================
// IMAGE SETUP
// =========================
function showImageSetup() {
    document.getElementById('title-screen').classList.add('hidden');
    document.getElementById('image-setup-screen').classList.remove('hidden');
    generateSlots();
}

function generateSlots() {
    const grid = document.getElementById('slots-grid');
    grid.innerHTML = '';
    
    for (let i = 0; i < 10; i++) {
        const slot = document.createElement('div');
        slot.className = 'slot';
        
        slot.innerHTML = `
            <div class="slot-label">${i === 9 ? 'üî• BOSS LVL 10' : 'LEVEL ' + (i + 1)}</div>
            
            <div class="preview-box empty" id="neutral-preview-${i}">
                <span>Neutral Image</span>
            </div>
            <button class="btn-small" onclick="uploadImage(${i}, 'neutral')">üì∏ UPLOAD NEUTRAL</button>
            
            <div class="preview-box empty" id="reaction-preview-${i}">
                <span>Reaction Image</span>
            </div>
            <button class="btn-small" onclick="uploadImage(${i}, 'reaction')">üì∏ UPLOAD REACTION</button>
        `;
        
        grid.appendChild(slot);
        
        // Hidden file inputs
        ['neutral', 'reaction'].forEach(type => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.id = `${type}-input-${i}`;
            input.onchange = (e) => handleImageUpload(e, i, type);
            slot.appendChild(input);
        });
        
        // Initialize character data
        gameState.characters[i] = {
            neutralImg: null,
            reactionImg: null,
            emoji: presetEmojis[i],
            level: i + 1,
            isBoss: i === 9,
            voice: {
                type: 'tts',
                text: 'Nice hit!',
                voiceIndex: 0,
                blob: null
            }
        };
    }
}

function uploadImage(index, type) {
    document.getElementById(`${type}-input-${index}`).click();
}

function handleImageUpload(event, index, type) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
        const char = gameState.characters[index];
        
        if (type === 'neutral') {
            char.neutralImg = e.target.result;
        } else {
            char.reactionImg = e.target.result;
        }
        
        // Update preview
        const preview = document.getElementById(`${type}-preview-${index}`);
        preview.classList.remove('empty');
        preview.innerHTML = `<img src="${e.target.result}" alt="${type}">`;
    };
    
    reader.readAsDataURL(file);
}

function continueWithEmojis() {
    gameState.usingEmojis = true;
    showAudioSetup();
}

function continueWithImages() {
    gameState.usingEmojis = false;
    showAudioSetup();
}

// =========================
// AUDIO SETUP
// =========================
function showAudioSetup() {
    document.getElementById('image-setup-screen').classList.add('hidden');
    document.getElementById('audio-setup-screen').classList.remove('hidden');
    generateAudioPanels();
}

function generateAudioPanels() {
    const container = document.getElementById('audio-panels');
    container.innerHTML = '';
    
    gameState.characters.forEach((char, i) => {
        const panel = document.createElement('div');
        panel.className = 'voice-panel';
        
        panel.innerHTML = `
            <div style="font-size: 18px; font-weight: bold; color: #00ff88; margin-bottom: 10px;">
                LEVEL ${i + 1} ${char.isBoss ? '(BOSS)' : ''}
            </div>
            
            <div style="margin: 10px 0;">
                <label style="color: #aaa;">Select Voice:</label>
                <select id="voice-select-${i}" style="width: 100%;"></select>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="btn-small" onclick="testVoice(${i})">‚ñ∂Ô∏è TEST</button>
                <button class="btn-small" onclick="recordVoice(${i})" id="rec-${i}">üé§ RECORD</button>
            </div>
        `;
        
        container.appendChild(panel);
        
        // Populate voices
        const select = document.getElementById(`voice-select-${i}`);
        gameState.voices.forEach((voice, vIdx) => {
            const option = document.createElement('option');
            option.value = vIdx;
            option.textContent = `${voice.name} (${voice.lang})`;
            select.appendChild(option);
        });
    });
}

function testVoice(index) {
    const char = gameState.characters[index];
    const voiceIdx = parseInt(document.getElementById(`voice-select-${index}`).value);
    
    char.voice.voiceIndex = voiceIdx;
    
    const utterance = new SpeechSynthesisUtterance(char.voice.text);
    utterance.voice = gameState.voices[voiceIdx];
    utterance.volume = 1.0;
    window.speechSynthesis.speak(utterance);
}

async function recordVoice(index) {
    const btn = document.getElementById(`rec-${index}`);
    
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const recorder = new MediaRecorder(stream);
        const chunks = [];
        
        btn.textContent = '‚è∫Ô∏è RECORDING...';
        btn.disabled = true;
        
        recorder.ondataavailable = e => {
            if (e.data.size > 0) chunks.push(e.data);
        };
        
        recorder.onstop = () => {
            const blob = new Blob(chunks, { type: 'audio/webm' });
            gameState.characters[index].voice.blob = blob;
            gameState.characters[index].voice.type = 'recorded';
            
            btn.textContent = '‚úì RECORDED';
            btn.style.borderColor = '#ffd700';
            
            stream.getTracks().forEach(t => t.stop());
        };
        
        recorder.start();
        setTimeout(() => {
            if (recorder.state === 'recording') {
                recorder.stop();
                btn.disabled = false;
            }
        }, 2000);
        
    } catch (err) {
        alert('Microphone not available. Using text-to-speech.');
        btn.textContent = 'üé§ RECORD';
    }
}

// =========================
// PLATE BONUS
// =========================
let platesBroken = 0;
let plateInterval = null;

function startPlateBonus() {
    document.getElementById('audio-setup-screen').classList.add('hidden');
    document.getElementById('plate-bonus-screen').classList.remove('hidden');
    
    platesBroken = 0;
    spawnPlates();
}

function spawnPlates() {
    const container = document.getElementById('plates-container');
    container.innerHTML = '';
    
    for (let i = 0; i < 10; i++) {
        const plate = document.createElement('div');
        plate.className = 'plate';
        plate.id = `plate-${i}`;
        
        const x = 10 + (i % 5) * 18;
        const y = 20 + Math.floor(i / 5) * 50;
        
        plate.style.left = x + '%';
        plate.style.top = y + '%';
        
        plate.onclick = () => breakPlate(i);
        
        container.appendChild(plate);
        
        // Animate side to side
        animatePlate(plate, x);
    }
}

function animatePlate(plate, startX) {
    let x = startX;
    let dir = Math.random() > 0.5 ? 1 : -1;
    
    const move = setInterval(() => {
        if (!plate.parentNode) {
            clearInterval(move);
            return;
        }
        
        x += 0.3 * dir;
        
        if (x > startX + 10 || x < startX - 10) {
            dir *= -1;
        }
        
        plate.style.left = x + '%';
    }, 50);
}

function breakPlate(index) {
    const plate = document.getElementById(`plate-${index}`);
    if (!plate || plate.classList.contains('broken')) return;
    
    plate.classList.add('broken');
    platesBroken++;
    
    document.getElementById('plates-broken').textContent = `${platesBroken} / 10`;
    
    setTimeout(() => plate.remove(), 300);
    
    if (platesBroken >= 10) {
        document.getElementById('plates-complete-btn').classList.remove('hidden');
    }
}

// =========================
// MAIN GAME
// =========================
function startMainGame() {
    document.getElementById('plate-bonus-screen').classList.add('hidden');
    document.getElementById('game-container').style.display = 'block';
    
    gameState.currentLevel = 1;
    gameState.score = 0;
    
    startLevel();
}

function startLevel() {
    updateUI();
    clearCharacters();
    spawnCharacter();
}

function spawnCharacter() {
    const charData = gameState.characters[gameState.currentLevel - 1];
    
    const char = document.createElement('div');
    char.className = 'character';
    char.id = 'char-main';
    
    if (!gameState.usingEmojis && charData.neutralImg) {
        char.innerHTML = `
            <img src="${charData.neutralImg}" class="character-img">
            ${charData.reactionImg ? `<img src="${charData.reactionImg}" class="character-reaction">` : ''}
            <div class="hit-circle"></div>
        `;
    } else {
        char.innerHTML = `
            <div class="character-emoji">${charData.emoji}</div>
            <div class="hit-circle"></div>
        `;
    }
    
    char.style.left = '50%';
    char.style.top = '25%';
    char.style.transform = 'translateX(-50%)';
    
    document.getElementById('game-container').appendChild(char);
    
    gameState.activeCharacters.push({
        element: char,
        data: charData,
        hits: 0,
        needed: 5
    });
}

function clearCharacters() {
    gameState.activeCharacters.forEach(c => {
        if (c.element && c.element.parentNode) c.element.remove();
    });
    gameState.activeCharacters = [];
}

function updateUI() {
    document.getElementById('score-display').textContent = `SCORE: ${gameState.score}`;
    document.getElementById('level-display').textContent = `LEVEL: ${gameState.currentLevel}`;
}

// =========================
// SLINGSHOT
// =========================
let isDragging = false;
let basePos = { x: 0, y: 0 };
let ghost = null;

function initSlingshot() {
    const node = document.getElementById('slingshot-node');
    if (!node) return;
    const rect = node.getBoundingClientRect();
    basePos = { x: rect.left + rect.width/2, y: rect.top + rect.height/2 };
}

window.addEventListener('resize', initSlingshot);
setTimeout(initSlingshot, 100);

function handleStart(e) {
    const touch = e.touches ? e.touches[0] : e;
    if (touch.clientY < window.innerHeight / 2) return;
    
    isDragging = true;
    initSlingshot();
    
    ghost = document.createElement('div');
    ghost.className = 'ghost';
    ghost.textContent = 'üéØ';
    document.body.appendChild(ghost);
}

function handleMove(e) {
    if (!isDragging) return;
    e.preventDefault();
    
    const touch = e.touches ? e.touches[0] : e;
    
    ghost.style.left = touch.clientX + 'px';
    ghost.style.top = touch.clientY + 'px';
    
    updateBands(touch.clientX, touch.clientY);
    showTrajectory(touch.clientX, touch.clientY);
}

function handleEnd(e) {
    if (!isDragging) return;
    isDragging = false;
    
    const touch = e.changedTouches ? e.changedTouches[0] : e;
    
    const vx = (basePos.x - touch.clientX) * 0.3;
    const vy = (basePos.y - touch.clientY) * 0.3;
    
    if (ghost) ghost.remove();
    clearBands();
    clearTrajectory();
    
    if (Math.abs(vx) > 5 || Math.abs(vy) > 5) {
        launch(vx, vy);
    }
}

window.addEventListener('touchstart', handleStart);
window.addEventListener('touchmove', handleMove);
window.addEventListener('touchend', handleEnd);
window.addEventListener('mousedown', handleStart);
window.addEventListener('mousemove', handleMove);
window.addEventListener('mouseup', handleEnd);

function updateBands(tx, ty) {
    const bl = document.getElementById('band-l');
    const br = document.getElementById('band-r');
    if (!bl || !br) return;
    
    const angle = Math.atan2(ty - basePos.y, tx - basePos.x);
    const dist = Math.sqrt((tx - basePos.x)**2 + (ty - basePos.y)**2);
    
    bl.style.display = 'block';
    bl.style.left = basePos.x + 'px';
    bl.style.top = basePos.y + 'px';
    bl.style.width = dist + 'px';
    bl.style.transform = `rotate(${angle}rad)`;
    
    br.style.display = 'block';
    br.style.left = basePos.x + 'px';
    br.style.top = basePos.y + 'px';
    br.style.width = dist + 'px';
    br.style.transform = `rotate(${angle}rad)`;
}

function clearBands() {
    const bl = document.getElementById('band-l');
    const br = document.getElementById('band-r');
    if (bl) bl.style.display = 'none';
    if (br) br.style.display = 'none';
}

function showTrajectory(startX, startY) {
    clearTrajectory();
    
    const vx = (basePos.x - startX) * 0.3;
    const vy = (basePos.y - startY) * 0.3;
    
    let px = basePos.x;
    let py = basePos.y;
    let velX = vx;
    let velY = vy;
    const gravity = 0.5;
    
    for (let i = 0; i < 20; i++) {
        px += velX;
        py += velY;
        velY += gravity;
        
        if (py > window.innerHeight) break;
        
        const dot = document.createElement('div');
        dot.className = 'trajectory-dot';
        dot.style.left = px + 'px';
        dot.style.top = py + 'px';
        document.body.appendChild(dot);
        gameState.trajectoryDots.push(dot);
    }
}

function clearTrajectory() {
    gameState.trajectoryDots.forEach(d => d.remove());
    gameState.trajectoryDots = [];
}

function launch(vx, vy) {
    const p = document.createElement('div');
    p.className = 'projectile';
    p.textContent = 'üéØ';
    document.body.appendChild(p);
    
    let px = basePos.x;
    let py = basePos.y;
    let velX = vx;
    let velY = vy;
    const gravity = 0.5;
    
    const fly = setInterval(() => {
        px += velX;
        py += velY;
        velY += gravity;
        
        p.style.left = px + 'px';
        p.style.top = py + 'px';
        
        if (py > window.innerHeight) {
            clearInterval(fly);
            checkHit(px, py);
            p.remove();
        }
    }, 20);
}

function checkHit(x, y) {
    const charState = gameState.activeCharacters[0];
    if (!charState) return;
    
    const rect = charState.element.getBoundingClientRect();
    const cx = rect.left + rect.width / 2;
    const cy = rect.top + rect.height / 2;
    
    const dist = Math.sqrt((x - cx)**2 + (y - cy)**2);
    
    if (dist < 150) {
        charState.hits++;
        
        charState.element.classList.add('reacting');
        setTimeout(() => charState.element.classList.remove('reacting'), 500);
        
        playVoice(charState.data);
        
        gameState.score += 100;
        updateUI();
        
        if (charState.hits >= charState.needed) {
            setTimeout(() => levelComplete(), 500);
        }
    }
}

function playVoice(charData) {
    const voice = charData.voice;
    
    if (voice.type === 'recorded' && voice.blob) {
        const url = URL.createObjectURL(voice.blob);
        const audio = new Audio(url);
        audio.volume = 1.0;
        audio.play().catch(err => console.log('Audio play error:', err));
    } else {
        const utterance = new SpeechSynthesisUtterance(voice.text);
        utterance.voice = gameState.voices[voice.voiceIndex] || gameState.voices[0];
        utterance.volume = 1.0;
        window.speechSynthesis.speak(utterance);
    }
}

function levelComplete() {
    clearCharacters();
    
    document.getElementById('level-stats').innerHTML = `
        <h2 style="color: #00ff88;">LEVEL ${gameState.currentLevel} COMPLETE!</h2>
        <p style="font-size: 24px;">SCORE: ${gameState.score}</p>
    `;
    
    document.getElementById('level-complete-screen').classList.remove('hidden');
}

function nextLevel() {
    document.getElementById('level-complete-screen').classList.add('hidden');
    
    gameState.currentLevel++;
    
    if (gameState.currentLevel > 10) {
        victory();
    } else {
        startLevel();
    }
}

function victory() {
    document.getElementById('game-container').style.display = 'none';
    
    document.getElementById('victory-stats').innerHTML = `
        <h2 style="color: #00ff88;">ALL 10 LEVELS COMPLETE!</h2>
        <p style="font-size: 32px;">FINAL SCORE: ${gameState.score}</p>
    `;
    
    document.getElementById('victory-screen').classList.remove('hidden');
}
</script>
</body>
</html>
