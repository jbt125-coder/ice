<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Support ICE? Game</title>
    <style>
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; background: #2c3e50; font-family: 'Arial Rounded MT Bold', sans-serif;
            touch-action: none;
        }
        #game-container { position: relative; width: 100vw; height: 100vh; background: #87CEEB; display: none; }
        
        /* Overlays */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); color: white; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
            z-index: 100; text-align: center; padding: 20px; box-sizing: border-box;
        }

        /* Targets */
        #target-agent {
            position: absolute; width: 260px; height: 320px;
            background-size: contain; background-repeat: no-repeat;
            top: 15%; left: 50%; transform: translateX(-50%); z-index: 5;
        }

        /* Slingshot & Physics */
        #slingshot-node {
            position: absolute; bottom: 80px; left: 50%;
            width: 20px; height: 20px; background: #fff; border-radius: 50%;
            transform: translateX(-50%); z-index: 10;
        }
        .band {
            position: absolute; height: 6px; background: #4d2600;
            transform-origin: left center; z-index: 9; border-radius: 3px;
        }
        .projectile { position: absolute; font-size: 50px; z-index: 15; transform: translate(-50%, -50%); }
        .ghost { opacity: 0.5; pointer-events: none; position: absolute; font-size: 50px; z-index: 14; transform: translate(-50%, -50%); }

        /* UI */
        #score-board {
            position: absolute; top: 50px; width: 100%; text-align: center;
            font-size: 35px; color: white; text-shadow: 3px 3px 0 #000; z-index: 50;
        }
        button {
            padding: 15px; margin: 5px; border-radius: 12px; border: none;
            background: #f1c40f; font-weight: bold; width: 80%; font-size: 16px;
        }
        #yt-player { position: absolute; width: 1px; height: 1px; opacity: 0; }
    </style>
</head>
<body>

<div id="yt-player"></div>

<div id="title-screen" class="overlay">
    <h1>HOW DO YOU SUPPORT ICE?</h1>
    <p>This app requires access to your:<br>Camera Roll, Microphone, and Audio.</p>
    <button onclick="requestPermissions()">ALLOW ACCESS & PROCEED</button>
</div>

<div id="setup-screen" class="overlay" style="display:none;">
    <h3>1. CHOOSE TARGET PHOTO</h3>
    <input type="file" id="image-input" accept="image/*" style="margin-bottom:15px;">
    
    <h3>2. CHOOSE SYSTEM VOICE</h3>
    <button onclick="initVoices()">REFRESH VOICE LIST</button>
    <select id="voice-select" style="width:80%; padding:10px; margin:10px;"></select>
    
    <h3>3. RECORD CUSTOM SOUNDS</h3>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
        <button onclick="record(0)">ðŸŽ¤ Ew Gross</button>
        <button onclick="record(1)">ðŸŽ¤ I <3 Shit</button>
        <button onclick="record(2)">ðŸŽ¤ My Balls!</button>
        <button onclick="record(3)">ðŸŽ¤ Ouch</button>
        <button onclick="record(4)">ðŸŽ¤ Thanks</button>
        <button onclick="record(5)">ðŸŽ¤ Is this Piss?</button>
    </div>
    
    <button style="background:#2ecc71; font-size:22px; margin-top:20px;" onclick="startGame()">START GAME</button>
</div>

<div id="game-container">
    <div id="score-board">SCORE: 0</div>
    <div id="target-agent"></div>
    <div id="slingshot-node"></div>
    <div id="band-l" class="band"></div>
    <div id="band-r" class="band"></div>
</div>

<script>
    // YouTube API Setup
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    var player;
    function onYouTubeIframeAPIReady() {
        player = new YT.Player('yt-player', {
            height: '1', width: '1',
            videoId: 'rog8ou-ZepE',
            playerVars: { 'autoplay': 1, 'loop': 1, 'playlist': 'rog8ou-ZepE' },
            events: { 'onReady': (e) => e.target.mute() } // Start muted for iOS autoplay rules
        });
    }

    let score = 0;
    let ammo = 'poop';
    let voices = [];
    let customSounds = [null, null, null, null, null, null];
    const defaults = ["Ew gross", "I love that shit", "Oh my balls", "Ouch", "Thank you", "Is this piss?"];

    function requestPermissions() {
        if(confirm("Allow app to access Camera Roll and Microphone?")) {
            document.getElementById('title-screen').style.display = 'none';
            document.getElementById('setup-screen').style.display = 'flex';
            if (player) player.unMute();
        }
    }

    function initVoices() {
        voices = window.speechSynthesis.getVoices();
        const sel = document.getElementById('voice-select');
        sel.innerHTML = voices.map((v, i) => `<option value="${i}">${v.name}</option>`).join('');
    }

    async function record(i) {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const rec = new MediaRecorder(stream);
        const chunks = [];
        rec.ondataavailable = e => chunks.push(e.data);
        rec.onstop = () => customSounds[i] = URL.createObjectURL(new Blob(chunks));
        rec.start();
        setTimeout(() => { rec.stop(); alert("RECORDED!"); }, 1500);
    }

    function playSfx(i) {
        if (customSounds[i]) { new Audio(customSounds[i]).play(); }
        else {
            const msg = new SpeechSynthesisUtterance(defaults[i]);
            msg.voice = voices[document.getElementById('voice-select').value];
            window.speechSynthesis.speak(msg);
        }
    }

    // Image Upload
    document.getElementById('image-input').onchange = function(e) {
        const reader = new FileReader();
        reader.onload = (event) => {
            document.getElementById('target-agent').style.backgroundImage = `url(${event.target.result})`;
        };
        reader.readAsDataURL(e.target.files[0]);
    };

    function startGame() {
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('game-container').style.display = 'block';
        if (player) player.playVideo();
        runAgent();
    }

    let agentX = 50, agentDir = 1;
    function runAgent() {
        setInterval(() => {
            agentX += 1.5 * agentDir;
            if (agentX > 80 || agentX < 20) agentDir *= -1;
            document.getElementById('target-agent').style.left = agentX + '%';
        }, 20);
    }

    // SNAPPY SLINGSHOT LOGIC
    let isDragging = false;
    let basePos = { x: window.innerWidth/2, y: window.innerHeight - 90 };
    let ghost = null;

    window.addEventListener('touchstart', e => {
        const t = e.touches[0];
        if (t.clientY > window.innerHeight - 200) {
            isDragging = true;
            ghost = document.createElement('div');
            ghost.className = 'ghost';
            ghost.innerHTML = ammo === 'poop' ? 'ðŸ’©' : 'âš¾';
            document.body.appendChild(ghost);
        }
    });

    window.addEventListener('touchmove', e => {
        if (!isDragging) return;
        const t = e.touches[0];
        const dx = t.clientX - basePos.x;
        const dy = t.clientY - basePos.y;
        const angle = Math.atan2(dy, dx);
        const dist = Math.min(Math.sqrt(dx*dx + dy*dy), 150);

        ghost.style.left = (basePos.x + Math.cos(angle)*dist) + 'px';
        ghost.style.top = (basePos.y + Math.sin(angle)*dist) + 'px';

        updateBands(basePos.x + Math.cos(angle)*dist, basePos.y + Math.sin(angle)*dist);
    });

    window.addEventListener('touchend', e => {
        if (!isDragging) return;
        isDragging = false;
        const t = e.changedTouches[0];
        const vx = (basePos.x - t.clientX) * 0.35; // HIGH POWER SENSITIVITY
        const vy = (basePos.y - t.clientY) * 0.35;
        
        ghost.remove();
        clearBands();
        if (Math.abs(vy) > 5) launch(vx, vy);
    });

    function updateBands(tx, ty) {
        const bl = document.getElementById('band-l'), br = document.getElementById('band-r');
        const angle = Math.atan2(ty - basePos.y, tx - basePos.x);
        const dist = Math.sqrt((tx-basePos.x)**2 + (ty-basePos.y)**2);
        [bl, br].forEach(b => {
            b.style.display = 'block';
            b.style.left = basePos.x + 'px'; b.style.top = basePos.y + 'px';
            b.style.width = dist + 'px'; b.style.transform = `rotate(${angle}rad)`;
        });
    }

    function clearBands() {
        document.getElementById('band-l').style.display = 'none';
        document.getElementById('band-r').style.display = 'none';
    }

    function launch(vx, vy) {
        const p = document.createElement('div');
        p.className = 'projectile';
        p.innerHTML = ammo === 'poop' ? 'ðŸ’©' : 'âš¾';
        document.body.appendChild(p);

        let px = basePos.x, py = basePos.y, s = 1.0, current = ammo;
        let fly = setInterval(() => {
            px += vx; py += vy; s -= 0.03;
            p.style.left = px + 'px'; p.style.top = py + 'px';
            p.style.transform = `translate(-50%, -50%) scale(${s})`;
            if (s <= 0.2) { 
                check(px, py, current); clearInterval(fly); p.remove(); 
            }
        }, 20);
        ammo = ammo === 'poop' ? 'ball' : 'poop';
    }

    function check(x, y, type) {
        const r = document.getElementById('target-agent').getBoundingClientRect();
        const mx = r.left + r.width/2;
        if (type === 'poop' && Math.abs(x - mx) < 60 && Math.abs(y - (r.top + 100)) < 60) {
            score += 100; playSfx(Math.floor(Math.random()*2));
        } else if (type === 'ball' && Math.abs(x - mx) < 60 && Math.abs(y - (r.bottom - 60)) < 60) {
            score += 200; playSfx(2 + Math.floor(Math.random()*2));
        }
        document.getElementById('score-board').innerText = "SCORE: " + score;
    }
</script>
</body>
</html>
